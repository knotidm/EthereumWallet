<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">

<head>
    <title>Func Token Wallet</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet"
          type="text/css">
    <link rel="icon" type="image/png" href="public/favicon-32x32.png" sizes="32x32">
    <script src="web3/web3.min.js"></script>
    <script src="vue/vue.js"></script>

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body style="background-image: url(images/hero_bg.jpg)">

<div id="wallet" class="col-md-5">
    <p class="page-header" style="color:wheat;">Wallet</p>
    <ul class="list-group">
        <li class="list-group-item">Address {{ address }}</li>
        <li class="list-group-item">Ether Balance {{ etherBalance }}</li>
        <li class="list-group-item">BitCoin Balance {{ bitCoinBalance }}</li>
        <li class="list-group-item">Number Of Tokens {{ tokens }}</li>
    </ul>
</div>

<div id="buyTokens" class="col-md-5">
    <p class="page-header" style="color:wheat;">Buy Tokens</p>
    <ul class="list-group">
        <li class="list-group-item">Token Price (ETH) <span id="tokenPrice"/></li>
        <li class="list-group-item">Amount <label><input class="input-lg" type="number" v-model.number="amount"></label>
        <li class="list-group-item" style="text-align: center">
            <button class="btn btn-primary btn-outline" v-on:click="buy">Buy</button>
        </li>
    </ul>
</div>

<!--<div id="etherTransactions" class="col-md-5">-->
<!--<p class="page-header" style="color:wheat;">Ether Transactions</p>-->
<!--<table :headers="headers" :items="items">-->
<!--<template slot="items" slot-scope="props">-->
<!--<td>{{ props.item.to }}</td>-->
<!--<td>{{ props.item.from }}</td>-->
<!--<td>{{ props.item.amount }}</td>-->
<!--</template>-->
<!--</table>-->
<!--</div>-->

<div class="col-md-5">
    <p class="page-header" style="color:wheat;">Bitcoin Transactions</p>
    <table class="table">
        <thead>
        <tr class="text-info">
            <th>Date</th>
            <th>TXID</th>
            <th>Payment (BTC)</th>
            <th>Fee (BTC)</th>
        </tr>
        </thead>
        <tbody id="bitCoinTransactionsTable">
        </tbody>
    </table>
</div>

<div id="ownerPanel" class="col-md-5" v-if="show">
    <p class="page-header" style="color:wheat;">Owner Panel</p>
    <ul class="list-group">
        <li class="list-group-item">Number Of All Tokens {{ allTokens }}</li>
        <li class="list-group-item">Set Number of all Tokens <label><input class="input-lg" type="number"
                                                                           v-model.number="numberOfAllTokens"></label>
        <li class="list-group-item" style="text-align: center">
            <button class="btn btn-primary btn-outline" v-on:click="setAllTokens">Set</button>
        </li>
    </ul>
</div>

<script>

    let web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    web3.eth.defaultAccount = web3.eth.accounts[0];

    const config = {
        contractAddress: '0x66a14399674254852acdb7ab72ae5f3fedde0b25',
        contractAbi: [
            {
                "constant": true,
                "inputs": [],
                "name": "numberOfAvailableTokens",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "getNumberOfAllTokens",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "_address",
                        "type": "address"
                    }
                ],
                "name": "getNumberOfTokens",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "getTokenPrice",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "numberOfAllTokens",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "getContractOwner",
                "outputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "numberOfSoldTokens",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "setTokenPrice",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "setNumberOfAllTokens",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "payable": true,
                "stateMutability": "payable",
                "type": "fallback"
            }
        ]
    };

    const contract = web3.eth.contract(config.contractAbi).at(config.contractAddress, (error, contract) => {
        return contract
    });

    let wallet = new Vue({

        el: '#wallet',

        data: {
            address: "",
            etherBalance: 0,
            bitCoinBalance: 0,
            tokens: 0
        },

        mounted() {
            this.getAddress();
            this.getEtherBalance();
            this.getNumberOfTokens();
        },

        methods: {
            getAddress() {
                this.address = web3.eth.defaultAccount;
            },

            getEtherBalance() {
                contract._eth.getBalance(this.address, (error, balance) => {
                    if (!error) {
                        this.etherBalance = web3.fromWei(balance, 'ether').toNumber();
                    } else
                        console.log(error);
                })
            },

            getNumberOfTokens() {
                contract.getNumberOfTokens(this.address, (error, tokens) => {
                    if (!error) {
                        this.tokens = tokens.toNumber();
                    } else
                        console.log(error);
                })
            },


        }
    });

    let buyTokens = new Vue({

        el: '#buyTokens',

        data: {
            amount: null
        },

        mounted() {
            this.getTokenPrice();
        },

        methods: {

            getTokenPrice() {
                contract.getTokenPrice(function (error, tokenPrice) {
                    if (!error) {
                        document.getElementById("tokenPrice").innerHTML = web3.fromWei(tokenPrice, 'ether').toNumber();
                    } else
                        console.log(error);
                });
            },

            buy: function (event) {
                if (this.amount <= 0) {
                    alert('Invalid amount!');
                    this.amount = null;
                    return;
                }

                let sum = web3.toWei(this.amount * document.getElementById("tokenPrice").innerHTML, 'ether');

                // contract.buyTokens(this.amount, (error, response) => {
                //     if (!error) {
                //         console.log(response);
                //         this.amount = null;
                //         return
                //     }
                //     console.log(error);
                //     this.amount = null
                // });

                web3.eth.sendTransaction({
                    from: wallet.address,
                    to: contract.address,
                    value: sum,
                    gasLimit: 21000,
                    gasPrice: 20000000000
                });

                wallet.getEtherBalance();
                wallet.getNumberOfTokens();
                ownerPanel.getNumberOfAllTokens();
                getBitCoinInfo();
            }
        }
    });

    // let etherTransactions = new Vue({
    //
    //     el: '#etherTransactions',
    //
    //     data() {
    //         return {
    //             headers: [
    //                 {align: 'left', text: 'To', value: 'to'},
    //                 {align: 'left', text: 'From', value: 'from'},
    //                 {align: 'left', text: 'Amount', value: 'amount'}
    //             ],
    //             items: []
    //         }
    //     },
    //
    //     mounted() {
    //
    //         // getTransactionsByAccount(web3.eth.coinbase);
    //
    //         web3.eth.filter({
    //             address: web3.eth.coinbase,
    //             from: 1,
    //             to: 'latest'
    //         }).get(function (err, result) {
    //             console.log(result);
    //         });
    //
    //         contract.Transfer({}, {fromBlock: 0, toBlock: 'pending'}, (err, res) => {
    //             console.log(this.items);
    //
    //             if (res.args.to === contract._eth.coinbase || res.args.from === contract._eth.coinbase) {
    //                 this.items.push({
    //                     to: res.args.to,
    //                     from: res.args.from,
    //                     amount: web3.fromWei(res.args.value).toNumber()
    //                 });
    //             }
    //         })
    //     }
    // });

    getBitCoinInfo();

    function getBitCoinInfo() {
        let jsonObject = {};
        let payments = {};
        let current = {};
        let getBitCoinInfo = "php/getBitCoinInfo.php";

        let xmlHttpRequest = new XMLHttpRequest();
        xmlHttpRequest.open("POST", getBitCoinInfo, true);
        xmlHttpRequest.onreadystatechange = function () {
            if (xmlHttpRequest.readyState === 4) {
                if (xmlHttpRequest.status === 200) {
                    jsonObject = JSON.parse(xmlHttpRequest.responseText);

                    payments = jsonObject.result.payments;
                    current = jsonObject.result.current;

                    let table = document.getElementById("bitCoinTransactionsTable");

                    if (payments && current) {

                        for (let i = 0; i < table.rows.length; i++) {
                            table.deleteRow(i);
                        }

                        for (let i = 0; i < payments.length; i++) {
                            let row = table.insertRow(0);
                            let cell0 = row.insertCell(0);
                            let cell1 = row.insertCell(1);
                            let cell2 = row.insertCell(2);
                            let cell3 = row.insertCell(3);
                            cell0.innerHTML = new Date(payments[i].time * 1000);
                            cell1.innerHTML = payments[i].TXID;
                            cell2.innerHTML = (payments[i].amount / ownerPanel.allTokens) * wallet.tokens;
                            cell3.innerHTML = (payments[i].fee / ownerPanel.allTokens) * wallet.tokens;
                        }

                        wallet.bitCoinBalance = 0;
                        for (let i = 0; i < current.length; i++) {
                            wallet.bitCoinBalance += (Number(current[i].data[1]) / ownerPanel.allTokens) * wallet.tokens;
                        }
                    } else alert("Failed to load resource, request must wait every 30 seconds until stats are refreshed");
                }
            }
        };
        xmlHttpRequest.onerror = function () {
            alert("Failed to load resource, request must wait every 30 seconds until stats are refreshed");
        };
        xmlHttpRequest.send(null);
    }

    let ownerPanel = new Vue({

        el: '#ownerPanel',

        data: {
            show: true,
            allTokens: 0,
            numberOfAllTokens: 0
        },

        mounted() {
            this.getContractOwnerAddress();
            this.getNumberOfAllTokens();
        },

        methods: {
            getContractOwnerAddress() {
                contract.getContractOwner(function (error, contractOwner) {
                    if (!error) {
                        if (wallet.address === contractOwner) {
                            ownerPanel.show = true;
                        } else if (wallet.address !== contractOwner) {
                            ownerPanel.show = false;
                        }
                    } else
                        console.log(error);
                });
            },

            getNumberOfAllTokens() {
                contract.getNumberOfAllTokens((error, allTokens) => {
                    if (!error) {
                        this.allTokens = allTokens.toNumber();
                    } else
                        console.log(error);
                })
            },

            setAllTokens: function (event) {
                contract.setNumberOfAllTokens(this.numberOfAllTokens, (error, result) => {
                    if (!error) {
                        console.log(result);
                    } else
                        console.log(error);
                });

                this.getNumberOfAllTokens();
            }
        },
    });

</script>

</body>

</html>